{% extends 'config_base.html' %}
{% block content %}
<h1>Cached Data Reader Builder Form</h1>
<pre>
The cached data reader is more complex than regular items and as such the form layout is slightly different.
As you need to, add KV pairs for the subcription list of dicts.
</pre>
<hr>

<div style="display: flex; width:100%; gap: 10px; flex-direction: row;">
    <div style="display: flex;  gap: 10px; flex-direction: column;">
        <form method="post" id="reader_form">
            <table class="table-bordered">
                {% csrf_token %}

                {{form.as_table}}
            </table>

            {% for f in formsets %}

            <h4>{{f.name}}:</h4>

            <table id="{{f.name}}-formset-container">
                <tr>
                    {{ f.formset.management_form }}
                </tr>
                <tbody id="formset-{{f.name}}" style=" border: 1px solid black;">
                    {% for subform in f.formset %}
                    <tr class="subform-{{f.name}}" id="formset-{{f.name}}-{{forloop.counter0}}">
                        <td>
                            <table>
                                {% for field in subform.visible_fields %}
                                <tr>
                                    <th>{{ field.label_tag }}</th>
                                    <td>
                                        {{ field.errors }}
                                        {{ field }}
                                        {{ field.help_text }}
                                    </td>
                                </tr>
                                {% endfor %}

                            </table>
                        </td>

                    </tr>
                    {% endfor %}
                    <tr id="subform-{{f.name}}-lastelement">
                        <td>
                            <button id="{{f.name}}" type="button" id="add-subform" onclick="add_formset(this.id);">Add Key-Value Pair</button>
                        </td>
                    </tr>
                    </tr>
                </tbody>

                {% endfor %}
                <tfoot>
                    <tr>
                        <td>
                            <input type="hidden" name="_method" value="PATCH">
                            <button type="submit">Submit to render</button>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </form>
    </div>
    <div>
        {% if post_form %} <form method="post">


            <div style="display: flex; flex-direction: row; gap: 30px;">

                <div>
                    <table class="table-bordered">
                        {% csrf_token %}
                        {% for field in post_form.visible_fields %}
                        <tr>
                            <th>{{ field.label_tag }}</th>
                            <td>
                                {{ field.errors }}
                                {{ field }}
                                {{ field.help_text }}

                            </td>
                        </tr>

                        {%endfor%}

                    </table>
                </div>
                <div>


                    <button type="submit">Save</button>
                </div>

            </div>
        </form>
        {%endif%}
    </div>
</div>



<div style="display: flex; width:100%; gap: 10px; flex-direction: row; flex-wrap: wrap;">
    <div>
        YAML<br>
        <textarea cols="80" rows="20">{{yaml_object}}</textarea>
    </div>
    <div>
        JSON<br>
        <textarea cols="80" rows="20">{{json_object}}</textarea>
    </div>

</div>



</body>
<script>

    function add_formset(e) {


        const formset = document.getElementById('formset-' + e);
        const TOTAL_FORMS = parseInt(document.getElementById('id_' + e + '-TOTAL_FORMS').value);

        let formIndex = TOTAL_FORMS;
        const subform = document.createElement('tr');

        subform.classList.add('subform-' + e)
        console.log('formset-' + e + '-0')
        subform.innerHTML = document.getElementById('formset-' + e + '-0').innerHTML;

        const inputs = subform.querySelectorAll("input", "select");

        inputs.forEach(input => {
            const newName = input.name.replace(/-\d+-/, `-${formIndex}-`);
            input.name = newName;
            input.value = '';
        });
        formset.insertBefore(subform, document.getElementById('subform-' + e + '-lastelement'));

        formIndex++;
        document.getElementById('id_' + e + '-TOTAL_FORMS').value = formIndex;
    }


</script>

{% endblock %}